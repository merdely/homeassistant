#!/bin/bash

# on = open
# off = closed

outd=$(mktemp -d)
curl -sLo $outd/snapshot.jpg http://garagedoorcam.erdely.in:8000/snapshot.jpg

match=0
convert $outd/snapshot.jpg -crop 1785x966+807+978 $outd/compare.jpg
for file in /config/gcam/doorclosed_*_cropped.jpg; do
  ret=$(compare -metric PSNR $file $outd/compare.jpg /dev/null 2>&1)
  [ $ret = inf ] && ret=100
  [ $(echo "$ret < 11.0" | bc) != 1 ] && match=1
done 
[ $match = 0 ] && echo on || echo off
rm -Rf $outd
