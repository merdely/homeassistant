#!/usr/bin/env python3

import os
import re
import sys

secrets = os.path.dirname(os.path.dirname(os.path.realpath(sys.argv[0]))) + '/secrets.yaml'
with open(secrets, 'r') as file:
    for line in file.readlines():
        m = re.search(r'mysql_uri: mysql://([^:]+):([^@]+)@([^/]+)/([^?]+)?', line)
        if m:
            sqlusername = m.group(1)
            sqlpassword = m.group(2)
            sqlhostname = m.group(3)
            sqldatabase = m.group(4)
file.close()

venv = '/srv/venv/mariadb'
if os.path.isdir(venv):
    for subdir in os.listdir(venv + '/lib'):
        sys.path.append(venv + '/lib/' + subdir + '/site-packages')

from MySQLdb import _mysql

if len(sys.argv) < 3:
    print('Usage: ' + sys.argv[0] + ' entity_id current_state')
    quit()
else:
    entity_id = sys.argv[1]
    current_state = sys.argv[2]

try:
   conn = _mysql.connect(host=sqlhostname,
                         user=sqlusername,
                         passwd=sqlpassword,
                         db=sqldatabase)
   query = "SELECT state FROM states WHERE entity_id = '{}' AND states.last_updated = (SELECT MAX(states2.last_updated) FROM states AS states2 WHERE states2.entity_id = states.entity_id AND state != 'unknown' AND state != '{}');".format(entity_id, current_state)
   conn.query(query)
   result = conn.store_result()

   rows = result.fetch_row(maxrows=0) 
   if len(rows) > 0:
       print(rows[0][0].decode('utf-8'))

   conn.close()

except Exception as error :
    print ("Error while fetching data from MySQL", error)
